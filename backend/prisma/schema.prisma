// Prisma Schema per Zenova E-commerce

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== PRODOTTI =====

model Product {
  id           Int      @id @default(autoincrement())
  bigbuyId     Int      @unique @map("bigbuy_id")
  sku          String   @unique
  name         String
  description  String?  @db.Text
  category     String?
  price        Decimal  @db.Decimal(10, 2)
  retailPrice  Decimal  @db.Decimal(10, 2) @map("retail_price")
  stock        Int      @default(0)
  images       Json?
  features     Json?
  weight       Decimal? @db.Decimal(8, 2)
  dimensions   Json?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  orderItems   OrderItem[]

  @@index([bigbuyId])
  @@index([sku])
  @@index([category])
  @@index([active])
  @@map("products")
}

// ===== CLIENTI =====

model Customer {
  id               Int      @id @default(autoincrement())
  email            String   @unique
  firstName        String   @map("first_name")
  lastName         String   @map("last_name")
  phone            String?
  addressLine1     String?  @map("address_line1")
  addressLine2     String?  @map("address_line2")
  city             String?
  postalCode       String?  @map("postal_code")
  province         String?
  country          String   @default("IT")
  newsletter       Boolean  @default(false)
  marketingConsent Boolean  @default(false) @map("marketing_consent")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  orders           Order[]

  @@index([email])
  @@map("customers")
}

// ===== ORDINI =====

model Order {
  id                Int       @id @default(autoincrement())
  orderNumber       String    @unique @map("order_number")
  customerId        Int?      @map("customer_id")
  customerEmail     String    @map("customer_email")
  customerName      String    @map("customer_name")
  customerPhone     String?   @map("customer_phone")
  shippingAddress   Json      @map("shipping_address")
  subtotal          Decimal   @db.Decimal(10, 2)
  shippingCost      Decimal   @default(0) @db.Decimal(10, 2) @map("shipping_cost")
  total             Decimal   @db.Decimal(10, 2)
  paymentMethod     String    @default("stripe") @map("payment_method")
  paymentStatus     String    @default("pending") @map("payment_status")
  stripeSessionId   String?   @map("stripe_session_id")
  stripePaymentId   String?   @map("stripe_payment_id")
  paidAt            DateTime? @map("paid_at")
  bigbuyOrderId     Int?      @map("bigbuy_order_id")
  bigbuyStatus      String?   @map("bigbuy_status")
  bigbuySentAt      DateTime? @map("bigbuy_sent_at")
  status            String    @default("pending")
  customerNotes     String?   @db.Text @map("customer_notes")
  internalNotes     String?   @db.Text @map("internal_notes")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  customer          Customer?  @relation(fields: [customerId], references: [id])
  items             OrderItem[]
  shipment          Shipment?

  @@index([orderNumber])
  @@index([customerId])
  @@index([customerEmail])
  @@index([status])
  @@index([paymentStatus])
  @@map("orders")
}

// ===== DETTAGLIO ORDINI =====

model OrderItem {
  id           Int      @id @default(autoincrement())
  orderId      Int      @map("order_id")
  productId    Int?     @map("product_id")
  bigbuyId     Int      @map("bigbuy_id")
  sku          String
  productName  String   @map("product_name")
  productImage String?  @map("product_image")
  unitPrice    Decimal  @db.Decimal(10, 2) @map("unit_price")
  quantity     Int      @default(1)
  totalPrice   Decimal  @db.Decimal(10, 2) @map("total_price")
  costPrice    Decimal? @db.Decimal(10, 2) @map("cost_price")
  createdAt    DateTime @default(now()) @map("created_at")

  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product? @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ===== SPEDIZIONI =====

model Shipment {
  id                  Int       @id @default(autoincrement())
  orderId             Int       @unique @map("order_id")
  trackingNumber      String?   @map("tracking_number")
  carrier             String?
  carrierService      String?   @map("carrier_service")
  shippedAt           DateTime? @map("shipped_at")
  estimatedDelivery   DateTime? @map("estimated_delivery")
  deliveredAt         DateTime? @map("delivered_at")
  status              String    @default("pending")
  trackingEmailSent   Boolean   @default(false) @map("tracking_email_sent")
  deliveryEmailSent   Boolean   @default(false) @map("delivery_email_sent")
  trackingEvents      Json?     @map("tracking_events")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  order               Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipments")
}

// ===== LOG SINCRONIZZAZIONI =====

model SyncLog {
  id              Int      @id @default(autoincrement())
  syncType        String   @map("sync_type")
  status          String
  itemsProcessed  Int      @default(0) @map("items_processed")
  errorMessage    String?  @db.Text @map("error_message")
  syncData        Json?    @map("sync_data")
  durationMs      Int?     @map("duration_ms")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([syncType])
  @@index([createdAt])
  @@map("sync_log")
}
